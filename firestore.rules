rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // HELPER
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // GENERIC OWNERSHIP CHECK
    function isDocOwner() {
      return isOwner(resource.data.uid);
    }
    function isCreatingDocForSelf() {
      return isOwner(request.resource.data.uid);
    }

    // USER PROFILE
    match /users/{userId} {
      allow get, list, update: if isOwner(userId);
      allow create: if isOwner(userId);
    }

    // USER SUBCOLLECTIONS
    match /users/{userId}/{subcollection}/{docId} {
        allow read, write: if isOwner(userId);
    }
    
    // PERMISSIONS
    match /permissions/{userId} {
      allow get: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isOwner(userId);
    }

    // ONBOARDING DATA
    match /onboardIntake/{docId} {
      allow create: if isCreatingDocForSelf();
      allow read, update, delete: if isDocOwner();
    }
    match /goals/{docId} {
      allow create: if isCreatingDocForSelf();
      allow read, update, delete: if isDocOwner();
    }
    match /tasks/{docId} {
      allow create: if isCreatingDocForSelf();
      allow read, update, delete: if isDocOwner();
    }
    match /calendarEvents/{docId} {
      allow create: if isCreatingDocForSelf();
      allow read, update, delete: if isDocOwner();
    }
    match /habitWatch/{docId} {
      allow create: if isCreatingDocForSelf();
      allow read, update, delete: if isDocOwner();
    }

    // MAIN APP DATA
    match /audioEvents/{docId} {
      allow create: if isCreatingDocForSelf();
      allow read, list, update, delete: if isDocOwner();
    }
    match /voiceEvents/{docId} {
      allow create: if isCreatingDocForSelf();
      allow read, list, update, delete: if isDocOwner();
    }
    match /people/{docId} {
      allow create: if isCreatingDocForSelf();
      allow read, list, update, delete: if isDocOwner();
    }
    match /dreamEvents/{docId} {
      allow create: if isCreatingDocForSelf();
      allow read, list, update, delete: if isDocOwner();
    }
    match /innerTexts/{docId} {
      allow create: if isCreatingDocForSelf();
      allow read, list, update, delete: if isDocOwner();
    }
    match /cameraCaptures/{docId} {
      allow create: if isCreatingDocForSelf();
      allow read, list, update, delete: if isDocOwner();
    }
    match /symbolicImageInsights/{docId} {
      allow create: if isCreatingDocForSelf();
      allow read, list, update, delete: if isDocOwner();
    }
  }
}
