
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // User-specific data collections
    match /{collection}/{uid}/{document=**} {
      where collection in ['users', 'permissions', 'tasks', 'moodTrends', 'voiceTranscripts', 'b2bExportOptIn', 'audioEvents', 'voiceEvents', 'people', 'dreams', 'innerTexts', 'faceSnapshots', 'auraStates', 'memoryBlooms', 'emotionCycles', 'onboardIntake', 'goals', 'calendarEvents', 'habitWatch', 'emotionEvents', 'socialOverlays', 'recoveryBlooms', 'ritualCards', 'monetizationLog', 'timelineEvents', 'shadowEpisodes', 'forecastProfiles', 'archetypeStates', 'legacyThreads', 'presentMetrics', 'orbState', 'orbEvents', 'orbDialogMemory', 'orbSymbolicMap', 'voiceClips', 'transcriptTags', 'ambientTone', 'narratorInsights', 'torsoMetrics', 'habitEvents', 'legsMetrics', 'movementPaths', 'avoidanceEvents', 'armMetrics', 'relationalGestures', 'socialEvents', 'messages'] {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
    }

    // Partner & B2B collections - restricted access
    match /partnerAuth/{partnerId} {
      allow read, write: if false; // Only accessible via Admin SDK in Cloud Functions
    }

    match /dataMarketplace/packages/{packageId} {
      allow read: if request.auth != null; // Allow authenticated users to see packages
      allow write: if request.auth.token.admin == true; // Admin only
    }

    match /darRequests/{requestId} {
      allow read, write: if request.auth.token.admin == true; // Admin only
    }

    match /exportSummaries/{exportId} {
      allow read: if request.auth.token.admin == true || get(/databases/$(database)/documents/partnerAuth/$(request.auth.token.partnerId)).data.apiKey == resource.data.partnerApiKey; // Admin or the correct partner
      allow write: if request.auth.token.admin == true;
    }
    
    // Anonymized and exported data is not readable by clients
    match /anonymizedData/{hashId}/{metricId} {
      allow read, write: if false;
    }
    
    match /b2bExports/{week}/{reportId} {
      allow read, write: if false;
    }

    // Consent audit is append-only by Cloud Functions
    match /consentAudit/{auditId} {
        allow read: if request.auth.token.admin == true;
        allow write: if false;
    }

    // Daily digest queue is write-only for functions, not readable by client
    match /dailyDigestQueue/{uid} {
        allow read, write: if false;
    }

    // Mail collection for Trigger Email extension
    match /mail/{docId} {
      allow create: if true; // Allow clients or functions to queue emails
      allow read, update, delete: if false;
    }
  }
}
