
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read/write their own profile and top-level data collections.
    // This rule is designed to be comprehensive for all user-scoped data.
    match /{collection}/{uid}/{docId} 
      where collection in [
        'users', 'permissions', 'onboardIntake', 'goals', 'tasks', 'calendarEvents', 
        'habitWatch', 'armMetrics', 'relationalGestures', 'torsoMetrics', 'habitEvents', 
        'legsMetrics', 'movementPaths', 'avoidanceEvents', 'orbState', 'orbEvents', 
        'orbDialogMemory', 'orbSymbolicMap', 'socialContacts', 'socialEvents', 
        'timelineEvents', 'shadowEpisodes', 'forecastProfiles', 'archetypeStates', 
        'legacyThreads', 'presentMetrics', 'voiceClips', 'voiceTranscripts', 'transcriptTags',
        'ambientTone', 'emotionStars', 'forecastZones', 'cognitiveSeasons', 'dreamConstellations',
        'audioEvents', 'voiceEvents', 'dreams', 'innerTexts', 'faceSnapshots', 'people'
      ] {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // Secure user-specific sub-collections
    match /users/{uid}/{subcollection}/{docId} {
       allow read, write: if request.auth != null && request.auth.uid == uid;
    }
    
    // Narrator insights can be read/written by the user.
    match /narratorInsights/{uid}/{insightId} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
    
    // Backend-only write collections, readable by the user.
    match /{collection}/{uid}/{docId}
      where collection in ['notifications', 'mail', 'dailyDigestQueue'] {
      allow read: if request.auth.uid == uid;
      allow write: if false; // Only backend can write
    }

    // Collections for internal or anonymized data with restricted access.
    match /anonymizedData/{hashId}/{metricId} {
      allow read: if false;
      // Write access should be locked down to specific service accounts in production.
      allow write: if request.auth != null; 
    }
    
    match /b2bExports/{week}/{reportId} {
      allow read, write: if false;
    }
    
    // Audit logs are write-only by the backend, readable by the user.
    match /consentAudit/{uid}/{docId} {
      allow read: if request.auth.uid == uid;
      allow write: if false; // Backend only
    }
  }
}
