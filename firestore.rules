rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // User-owned data. Users can read and write their own documents in these collections.
    // This rule is a consolidation of all user-scoped data from the master prompts.
    match /{collection}/{uid}/{docId}
      where collection in [
        'users', 'permissions', 'people',
        'voiceEvents', 'audioEvents', 'dreams', 'innerTexts', 'faceSnapshots',
        'onboardIntake', 'goals', 'tasks', 'calendarEvents', 'habitWatch',
        'orbState', 'orbEvents', 'orbDialogMemory', 'orbSymbolicMap',
        'narratorInsights', 'voiceClips', 'voiceTranscripts', 'transcriptTags', 'ambientTone',
        'emotionEvents', 'socialOverlays', 'recoveryBlooms', 'ritualCards',
        'moodLogs', 'emotionCycles', 'memoryBlooms'
      ] {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // Subcollections under a user document
    match /users/{uid}/{subcollection}/{docId}
      where subcollection in ['auraStates', 'memoryBlooms', 'emotionCycles'] {
        allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // Special collections from B2B/Anonymization prompt are firewalled.
    match /anonymizedData/{hashId}/{metricId} {
      allow read: if false;
      allow write: if request.auth != null; // Should be restricted to service roles in production.
    }

    match /b2bExports/{week}/{reportId} {
      allow read: if false;
    }

    // Consent audit log is write-only for authenticated users, not readable.
    match /consentAudit/{auditId} {
      allow read: if false;
      allow write: if request.auth != null;
    }

    // Notification queue is write-only for authenticated users.
    match /messages/queue/{messageId} {
      allow read: if false;
      allow write: if request.auth != null;
    }
  }
}