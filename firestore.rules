rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read and write to their own user document.
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Rules for all subcollections under a user document.
      // This ensures that moodLogs, auraStates, etc., are also private.
      match /{subcollection}/{docId} {
         allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // This rule covers all other top-level collections.
    // It allows read/write if the document has a 'uid' or 'userId' field
    // that matches the authenticated user's ID.
    match /{collection}/{docId} {
       allow read, write: if request.auth != null && (
         (resource.data.uid == request.auth.uid) ||
         ('userId' in resource.data && resource.data.userId == request.auth.uid)
       );
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    // Allow users to read/write their own files in designated folders.
    match /{folder}/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
