
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // A user can read their own user document.
    // Writes are disabled as they are handled by backend functions on creation.
    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      allow write: if false; 
    }

    // A user can create and update their own permissions document during onboarding.
    match /permissions/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Generic rules for user-owned content collections.
    // This rule applies to any of the collections listed in the parentheses.
    match /{(
      "onboardIntake" | 
      "goals" | 
      "tasks" | 
      "calendarEvents" | 
      "habitWatch" | 
      "voiceEvents" | 
      "audioEvents" | 
      "people" | 
      "dreamEvents" | 
      "innerTexts"
    )}/{docId} {
        // Allow a user to create a document if the document's `uid` field
        // matches their own authenticated `uid`.
        allow create: if request.auth.uid == request.resource.data.uid;
        
        // Allow a user to read, update, or delete a document if they are the owner.
        allow read, update, delete: if request.auth.uid == resource.data.uid;
    }

    // Generic rule for all subcollections under a user's document.
    // This allows a user full access to things like their `auraStates` or `memoryBlooms`.
    match /users/{userId}/{collection}/{docId} {
       allow read, write: if request.auth.uid == userId;
    }
  }
}
