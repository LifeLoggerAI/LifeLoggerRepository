rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is signed in and is the owner of a document.
    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }
    
    // ====== USER DATA ======
    // Users can manage their own user document.
    match /users/{userId} {
      allow read, update, delete: if isOwner(userId);
      allow create: if isOwner(userId);
    }

    // Users can manage data in subcollections of their own user document.
    match /users/{userId}/{subcollection}/{docId} {
      allow read, write: if isOwner(userId);
    }

    // ====== ONBOARDING & PERMISSIONS ======
    // A user can create and manage their own permissions document.
    match /permissions/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // The `onboardIntake` collection stores the transcript from onboarding.
    match /onboardIntake/{docId} {
      allow create: if isOwner(request.resource.data.uid);
      allow read, update, delete: if isOwner(resource.data.uid);
    }

    // ====== CORE APP DATA ======
    // The following collections store user-generated content.
    // Access is granted if the document's `uid` field matches the user's auth uid.
    
    function canAccessOwnedDocument() {
      return (request.method == 'create' && isOwner(request.resource.data.uid)) ||
             (request.method != 'create' && isOwner(resource.data.uid));
    }

    match /goals/{docId} {
      allow read, write: if canAccessOwnedDocument();
    }
    match /tasks/{docId} {
      allow read, write: if canAccessOwnedDocument();
    }
    match /calendarEvents/{docId} {
      allow read, write: if canAccessOwnedDocument();
    }
    match /habitWatch/{docId} {
      allow read, write: if canAccessOwnedDocument();
    }
    match /audioEvents/{docId} {
      allow read, write: if canAccessOwnedDocument();
    }
    match /voiceEvents/{docId} {
      allow read, write: if canAccessOwnedDocument();
    }
    match /dreamEvents/{docId} {
      allow read, write: if canAccessOwnedDocument();
    }
    match /people/{docId} {
      allow read, write: if canAccessOwnedDocument();
    }
    match /innerTexts/{docId} {
      allow read, write: if canAccessOwnedDocument();
    }
    match /cameraCaptures/{docId} {
      allow read, write: if canAccessOwnedDocument();
    }
    match /symbolicImageInsights/{docId} {
      allow read, write: if canAccessOwnedDocument();
    }
  }
}
