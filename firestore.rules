rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // User-specific data is only accessible by the owner.
    match /{collection=users,permissions,audioEvents,voiceEvents,dreams,innerTexts,faceSnapshots,onboardIntake,goals,tasks,calendarEvents,habitWatch,people,voiceTranscripts,transcriptTags,ambientTone,emotionEvents,narratorInsights,socialOverlays,recoveryBlooms,ritualCards,monetizationLog}/{uid}/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // Specific collections for user sub-data, also owned by the user.
    match /users/{uid}/{subcollection=auraStates,memoryBlooms}/{docId} {
       allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // Partner auth data is not client-readable or writable.
    match /partnerAuth/{pid} {
      allow read, write: if false;
    }

    // Data Access Requests are only manageable by admins.
    match /darRequests/{rid} {
      allow read, write: if request.auth.token.admin == true;
    }

    // Export summaries are readable by admins and the specific partner.
    // Only admins can create them.
    match /exportSummaries/{eid} {
      allow read: if request.auth.token.admin == true ||
                  (resource.data.partnerId != null && request.auth.token.partnerId != null && resource.data.partnerId == request.auth.token.partnerId);
      allow write: if request.auth.token.admin == true;
    }

    // Anonymized and B2B data are not client-accessible.
    match /anonymizedData/{hashId}/{metricId} {
      allow read, write: if false;
    }

    match /b2bExports/{week}/{reportId} {
      allow read, write: if false;
    }
  }
}